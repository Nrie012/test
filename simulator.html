<!-- 【追加】GAS送信用関数をReactスクリプト冒頭に追加 -->
<script type="text/babel">
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwleBEqwFu54mgE7u06I3ykJMl9ALlMUTOUXTTFP1naKZ1lEQqWpUPC5D42yXzJrinS/exec'; // ←ここにあなたのGAS URLを入力

    const sendDataToGAS = async (payload) => {
        try {
            const res = await fetch(GAS_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            console.log('GAS保存完了:', result);
        } catch (error) {
            console.error('GAS送信エラー:', error);
        }
    };

    // App() 関数内部の一部 --- handlePlanningComplete を改修

    const handlePlanningComplete = (updatedAccounts, annualTotals) => {
        const updatedData = { ...appData, accounts: updatedAccounts, annualTotals };
        setAppData(updatedData);
        sendDataToGAS(updatedData);  // ← GASに送信！
        setScreen('result');
    };

    // （その他のコードは元のままでOK）

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>法人向け決算予測・税額シミュレーション</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .table-container {
            max-height: calc(100vh - 300px); /* Adjust based on your layout */
            overflow: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 定数定義 ---
        const APP_STORAGE_KEY = 'corporateTaxSimulatorData_v21'; // version up

        const PREFECTURES = [
            "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県", "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県", "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県", "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県", "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"
        ];

        // --- ヘルパー関数 ---
        const formatCurrency = (value) => {
            if (typeof value !== 'number' || isNaN(value)) return '0';
            return Math.round(value).toLocaleString();
        };
        
        // --- 税額計算ロジック ---
        const calculateTaxes = (preTaxProfit, capital, prefecture) => {
            const inhabitantsTaxBase = capital <= 10000000 ? 70000 : 180000;

            if (preTaxProfit <= 0) {
                return {
                    corporateTax: 0, localCorporateTax: 0, inhabitantsTax: inhabitantsTaxBase, enterpriseTax: 0, totalTax: inhabitantsTaxBase,
                    details: { inhabitants: { base: inhabitantsTaxBase, ratePortion: 0 }, enterprise: { incomePortion: 0 } }
                };
            }
            
            let corporateTax;
            const threshold = 8000000;
            if (preTaxProfit <= threshold) { corporateTax = preTaxProfit * 0.15; } 
            else { corporateTax = (threshold * 0.15) + ((preTaxProfit - threshold) * 0.232); }
            corporateTax = Math.round(corporateTax / 100) * 100;
            
            const localCorporateTax = Math.round((corporateTax * 0.103) / 100) * 100;
            
            const inhabitantsRate = prefecture === "東京都" ? 0.07 : 0.102;
            const inhabitantsRatePortion = Math.round((corporateTax * inhabitantsRate) / 100) * 100;
            const inhabitantsTax = inhabitantsTaxBase + inhabitantsRatePortion;
            
            let enterpriseTaxRate;
            if (preTaxProfit <= 4000000) { enterpriseTaxRate = 0.035; } 
            else if (preTaxProfit <= 8000000) { enterpriseTaxRate = 0.053; } 
            else { enterpriseTaxRate = 0.07; }
            const enterpriseTax = Math.round((preTaxProfit * enterpriseTaxRate) / 100) * 100;
            
            const totalTax = corporateTax + localCorporateTax + inhabitantsTax + enterpriseTax;
            
            return {
                corporateTax, localCorporateTax, inhabitantsTax, enterpriseTax, totalTax,
                details: { inhabitants: { base: inhabitantsTaxBase, ratePortion: inhabitantsRatePortion }, enterprise: { incomePortion: enterpriseTax } }
            };
        };

        // --- UIコンポーネント ---
        const Icon = ({ name, ...props }) => {
            if (window.lucide && window.lucide[name]) { return React.createElement(window.lucide[name], props); }
            return <span style={{ width: props.size || 18, height: props.size || 18, display: 'inline-block' }} />;
        };
        const Card = ({ children, className }) => <div className={`bg-white shadow-md rounded-lg p-6 ${className}`}>{children}</div>;
        const Button = ({ children, onClick, className = '', variant = 'primary', ...props }) => {
            const baseClasses = 'px-4 py-2 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 flex items-center justify-center gap-2';
            const variants = {
                primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
                secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',
                danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
            };
            return <button onClick={onClick} className={`${baseClasses} ${variants[variant]} ${className}`} {...props}>{children}</button>;
        };
        const Input = ({ label, ...props }) => (
            <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <input className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" {...props} />
            </div>
        );
        const Select = ({ label, children, ...props }) => (
            <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <select className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white" {...props}>{children}</select>
            </div>
        );

        // --- 画面コンポーネント ---
        const SetupScreen = ({ onSetupComplete }) => {
            const [fiscalYearStart, setFiscalYearStart] = useState(4);
            const [actualDataLastMonth, setActualDataLastMonth] = useState(new Date().getMonth() + 1);
            const [capital, setCapital] = useState(1000000);
            const [prefecture, setPrefecture] = useState("東京都");
            const [fileName, setFileName] = useState('');
            const [error, setError] = useState('');
            const [parsedAccounts, setParsedAccounts] = useState(null);
            const [isDragging, setIsDragging] = useState(false);

            const processFile = (file) => {
                if (file) {
                    setFileName(file.name);
                    Papa.parse(file, {
                        skipEmptyLines: true, encoding: "Shift-JIS",
                        complete: (results) => {
                            if (results.errors.length > 0) { setError("CSVファイルの解析に失敗しました。"); return; }
                            setError('');
                            
                            const data = results.data;
                            let headerRowIndex = -1, accountColIndex = -1, columnMapping = {};

                            for (let i = 0; i < Math.min(data.length, 10); i++) {
                                const row = data[i];
                                const monthCols = row.map((cell, index) => ({ cell, index })).filter(c => typeof c.cell === 'string' && /^\d{1,2}月$/.test(c.cell.trim()));
                                const adjustmentCol = row.findIndex(cell => typeof cell === 'string' && cell.includes('決算整理'));
                                const accountCol = row.findIndex(cell => typeof cell === 'string' && (cell.includes('科目') || cell.includes('摘要')));
                                
                                if (monthCols.length > 3 && accountCol !== -1) {
                                    headerRowIndex = i;
                                    accountColIndex = accountCol;
                                    monthCols.forEach(mc => {
                                        const monthNum = parseInt(mc.cell.match(/(\d+)/)[0]);
                                        columnMapping[mc.index] = { type: 'month', value: monthNum };
                                    });
                                    if (adjustmentCol !== -1) {
                                        columnMapping[adjustmentCol] = { type: 'adjustment' };
                                    }
                                    break;
                                }
                            }

                            if (headerRowIndex === -1) { setError("CSVからヘッダー行を特定できませんでした。"); return; }
                            
                            const dataRows = data.slice(headerRowIndex + 1);
                            const accounts = [];
                            let currentSection = 'revenue';

                            dataRows.forEach((row, index) => {
                                const accountName = row[accountColIndex]?.trim();
                                const sectionName = row[0]?.trim();
                                const displayName = accountName || sectionName;
                                if (!displayName) return;

                                let viewType = 'data';
                                let calcType = 'unknown';
                                
                                if (!accountName && sectionName) {
                                    viewType = 'sectionHeader';
                                    if (sectionName.includes('売上原価')) currentSection = 'cost';
                                    else if (sectionName.includes('販売費')) currentSection = 'expense';
                                    else if (sectionName.includes('営業外収益')) currentSection = 'nonOperatingRevenue';
                                    else if (sectionName.includes('営業外費用')) currentSection = 'nonOperatingExpense';
                                    else if (sectionName.includes('特別利益')) currentSection = 'specialIncome';
                                    else if (sectionName.includes('特別損失')) currentSection = 'specialLoss';
                                    else if (sectionName.includes('売上')) currentSection = 'revenue';
                                } else if (/利益|合計|損失/.test(displayName)) {
                                    viewType = 'summary';
                                    if (displayName.includes('売上総利益')) currentSection = 'expense';
                                    else if (displayName.includes('営業利益')) currentSection = 'nonOperating';
                                    else if (displayName.includes('経常利益')) currentSection = 'special';
                                    else if (displayName.includes('税引前')) currentSection = 'postTax';
                                } else {
                                    calcType = currentSection;
                                }

                                const values = Array(13).fill(0); // 12 months + 1 adjustment column
                                Object.entries(columnMapping).forEach(([colIndex, mappingInfo]) => {
                                    const value = row[colIndex];
                                    if(value) {
                                        const parsedValue = parseInt(String(value).replace(/,/g, ''), 10) || 0;
                                        if (mappingInfo.type === 'month') {
                                            let arrayIndex = mappingInfo.value - fiscalYearStart;
                                            if (arrayIndex < 0) arrayIndex += 12;
                                            values[arrayIndex] = parsedValue;
                                        } else if (mappingInfo.type === 'adjustment') {
                                            values[12] = parsedValue;
                                        }
                                    }
                                });
                                
                                accounts.push({ id: `${index}-${displayName}`, name: displayName, viewType, calcType, values });
                            });
                            setParsedAccounts(accounts);
                        },
                        error: (err) => { setError("ファイルの読み込みに失敗しました。"); }
                    });
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                processFile(file);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragging(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                processFile(file);
            };


            const handleSubmit = () => {
                if (!parsedAccounts) { setError("CSVファイルをアップロードしてください。"); return; }
                onSetupComplete({ fiscalYearStart, actualDataLastMonth, capital, prefecture, accounts: parsedAccounts });
            };

            return (
                <div className="max-w-4xl mx-auto p-8">
                    <h1 className="text-3xl font-bold text-gray-800 mb-2">決算予測・税額シミュレーション</h1>
                    <p className="text-gray-600 mb-8">事業計画に基づき、年度末の決算と法人税額をシミュレーションします。</p>
                    <Card>
                        <div className="space-y-6">
                            <h2 className="text-xl font-bold text-gray-700 border-b pb-2">1. 基本情報の設定</h2>
                            <div className="grid md:grid-cols-2 gap-6">
                                <Select label="事業年度 開始月" value={fiscalYearStart} onChange={e => setFiscalYearStart(parseInt(e.target.value))}>
                                    {[...Array(12).keys()].map(i => <option key={i+1} value={i+1}>{i+1}月</option>)}
                                </Select>
                                <Select label="実績データ最終月" value={actualDataLastMonth} onChange={e => setActualDataLastMonth(parseInt(e.target.value))}>
                                    {[...Array(12).keys()].map(i => <option key={i+1} value={i+1}>{i+1}月</option>)}
                                    <option value="13">決算整理</option>
                                </Select>
                                <Input label="資本金（円）" type="number" value={capital} onChange={e => setCapital(parseInt(e.target.value))} />
                                <Select label="主な事業所の都道府県" value={prefecture} onChange={e => setPrefecture(e.target.value)}>
                                    {PREFECTURES.map(p => <option key={p} value={p}>{p}</option>)}
                                </Select>
                            </div>
                            <h2 className="text-xl font-bold text-gray-700 border-b pb-2 pt-4">2. 会計データのインポート</h2>
                            <p className="text-red-600 font-bold text-sm mt-2">※ マネーフォワード クラウド会計の「推移表」＞「損益計算書」からエクスポートしたCSVファイルをインポートしてください。</p>
                            <div>
                                <label htmlFor="csv-upload" className="w-full">
                                    <div 
                                        onDragOver={handleDragOver}
                                        onDragLeave={handleDragLeave}
                                        onDrop={handleDrop}
                                        className={`mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed rounded-md cursor-pointer transition-colors ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-gray-50 hover:border-blue-500'}`}
                                    >
                                        <div className="space-y-1 text-center">
                                            <Icon name="UploadCloud" className="mx-auto h-12 w-12 text-gray-400" />
                                            <div className="flex text-sm text-gray-600">
                                                <p className="pl-1">{fileName ? `選択中のファイル: ${fileName}` : 'ファイルをドラッグ＆ドロップするか、ここをクリックして選択'}</p>
                                            </div>
                                            <p className="text-xs text-gray-500">CSV (Shift-JIS or UTF-8)</p>
                                        </div>
                                    </div>
                                </label>
                                <input id="csv-upload" name="csv-upload" type="file" accept=".csv" className="sr-only" onChange={handleFileChange} />
                            </div>
                            {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                            {parsedAccounts && <p className="text-green-600 text-sm mt-2">{fileName} を読み込みました。{parsedAccounts.length}件の科目を認識しました。</p>}
                            <div className="pt-6 flex justify-end">
                                <Button onClick={handleSubmit} disabled={!parsedAccounts}><Icon name="Play" size={18} />シミュレーションを開始</Button>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };
        
        const PlanningScreen = ({ initialData, onComplete, onReset }) => {
            const { fiscalYearStart, actualDataLastMonth } = initialData;
            const [accounts, setAccounts] = useState(initialData.accounts);

            const handleValueChange = (id, monthIndex, value) => {
                setAccounts(currentAccounts => 
                    currentAccounts.map(acc => 
                        acc.id === id ? { ...acc, values: acc.values.map((v, i) => i === monthIndex ? (parseInt(value.replace(/,/g, ''), 10) || 0) : v) } : acc
                    )
                );
            };
            
            const handleFillRight = (id, fromIndex) => {
                setAccounts(currentAccounts => {
                    const targetAccount = currentAccounts.find(acc => acc.id === id);
                    if (!targetAccount) return currentAccounts;

                    const valueToCopy = targetAccount.values[fromIndex];
                    const newValues = [...targetAccount.values];
                    // Fill up to the last month (index 11), excluding the adjustment column (index 12)
                    for (let i = fromIndex + 1; i < 12; i++) {
                        newValues[i] = valueToCopy;
                    }
                    return currentAccounts.map(acc => acc.id === id ? { ...acc, values: newValues } : acc);
                });
            };

            const months = useMemo(() => [...Array(12).keys()].map(i => (fiscalYearStart + i - 1) % 12 + 1), [fiscalYearStart]);
            const isActualMonth = useCallback((month) => {
                if (parseInt(actualDataLastMonth) === 13) {
                    return true; // If "決算整理" is selected, all months are actual data.
                }
                const yearStart = fiscalYearStart;
                const lastMonth = actualDataLastMonth;
                return (yearStart <= lastMonth) ? (month >= yearStart && month <= lastMonth) : (month >= yearStart || month <= lastMonth);
            }, [fiscalYearStart, actualDataLastMonth]);

            const calculatedTotals = useMemo(() => {
                const monthly = Array(12).fill(0).map(() => ({}));
                const annual = {};
                const adjustment = {};

                const sumByCalcType = (calcType) => {
                    const filtered = accounts.filter(a => a.calcType === calcType);
                    const monthlySums = Array(12).fill(0).map((_, i) => filtered.reduce((sum, acc) => sum + (acc.values[i] || 0), 0));
                    const adjustmentSum = filtered.reduce((sum, acc) => sum + (acc.values[12] || 0), 0);
                    const annualSum = monthlySums.reduce((sum, v) => sum + v, 0) + adjustmentSum;
                    return { monthly: monthlySums, annual: annualSum, adjustment: adjustmentSum };
                };
                
                const revenue = sumByCalcType('revenue');
                const cost = sumByCalcType('cost');
                const expenses = sumByCalcType('expense');
                const nonOpRevenue = sumByCalcType('nonOperatingRevenue');
                const nonOpExpense = sumByCalcType('nonOperatingExpense');
                const specialIncome = sumByCalcType('specialIncome');
                const specialLoss = sumByCalcType('specialLoss');

                for (let i = 0; i < 12; i++) {
                    monthly[i].revenue = revenue.monthly[i];
                    monthly[i].cost = cost.monthly[i];
                    monthly[i].grossProfit = monthly[i].revenue - monthly[i].cost;
                    monthly[i].expenses = expenses.monthly[i];
                    monthly[i].operatingProfit = monthly[i].grossProfit - monthly[i].expenses;
                    monthly[i].nonOpRevenue = nonOpRevenue.monthly[i];
                    monthly[i].nonOpExpense = nonOpExpense.monthly[i];
                    monthly[i].ordinaryProfit = monthly[i].operatingProfit + monthly[i].nonOpRevenue - monthly[i].nonOpExpense;
                    monthly[i].specialIncome = specialIncome.monthly[i];
                    monthly[i].specialLoss = specialLoss.monthly[i];
                    monthly[i].preTaxProfit = monthly[i].ordinaryProfit + monthly[i].specialIncome - monthly[i].specialLoss;
                }
                
                adjustment.revenue = revenue.adjustment;
                adjustment.cost = cost.adjustment;
                adjustment.grossProfit = adjustment.revenue - adjustment.cost;
                adjustment.expenses = expenses.adjustment;
                adjustment.operatingProfit = adjustment.grossProfit - adjustment.expenses;
                adjustment.nonOpRevenue = nonOpRevenue.adjustment;
                adjustment.nonOpExpense = nonOpExpense.adjustment;
                adjustment.ordinaryProfit = adjustment.operatingProfit + adjustment.nonOpRevenue - adjustment.nonOpExpense;
                adjustment.specialIncome = specialIncome.adjustment;
                adjustment.specialLoss = specialLoss.adjustment;
                adjustment.preTaxProfit = adjustment.ordinaryProfit + adjustment.specialIncome - adjustment.specialLoss;

                annual.revenue = revenue.annual;
                annual.cost = cost.annual;
                annual.grossProfit = annual.revenue - annual.cost;
                annual.expenses = expenses.annual;
                annual.operatingProfit = annual.grossProfit - annual.expenses;
                annual.nonOpRevenue = nonOpRevenue.annual;
                annual.nonOpExpense = nonOpExpense.annual;
                annual.ordinaryProfit = annual.operatingProfit + annual.nonOpRevenue - annual.nonOpExpense;
                annual.specialIncome = specialIncome.annual;
                annual.specialLoss = specialLoss.annual;
                annual.preTaxProfit = annual.ordinaryProfit + annual.specialIncome - annual.specialLoss;

                return { monthly, annual, adjustment };
            }, [accounts]);

            const renderRow = (item) => {
                 if (item.viewType === 'sectionHeader' || item.viewType === 'summary') {
                    let summaryKey = '';
                    if (item.name.includes('売上高合計') || item.name === '売上高') summaryKey = 'revenue';
                    else if (item.name.includes('売上原価合計') || item.name === '売上原価') summaryKey = 'cost';
                    else if (item.name.includes('販売費及び一般管理費')) summaryKey = 'expenses';
                    else if (item.name.includes('営業外収益合計') || item.name === '営業外収益') summaryKey = 'nonOpRevenue';
                    else if (item.name.includes('営業外費用合計') || item.name === '営業外費用') summaryKey = 'nonOpExpense';
                    else if (item.name.includes('特別利益合計') || item.name === '特別利益') summaryKey = 'specialIncome';
                    else if (item.name.includes('特別損失合計') || item.name === '特別損失') summaryKey = 'specialLoss';
                    else if (item.name.includes('売上総利益')) summaryKey = 'grossProfit';
                    else if (item.name.includes('営業利益')) summaryKey = 'operatingProfit';
                    else if (item.name.includes('経常利益')) summaryKey = 'ordinaryProfit';
                    else if (item.name.includes('税引前')) summaryKey = 'preTaxProfit';
                    
                    const rowClass = item.viewType === 'sectionHeader' ? 'bg-gray-100 font-bold' : 'bg-gray-200 border-b font-bold';

                    if (summaryKey) {
                        return (
                            <tr key={item.id} className={rowClass}>
                                <td className={`px-6 py-2 text-gray-800 sticky-col ${rowClass.split(' ')[0]}`}>{item.name}</td>
                                {months.map((_, index) => <td key={index} className="px-6 py-2 text-right text-gray-800">{formatCurrency(calculatedTotals.monthly[index][summaryKey])}</td>)}
                                <td className="px-6 py-2 text-right text-gray-800">{formatCurrency(calculatedTotals.adjustment[summaryKey])}</td>
                                <td className={`px-6 py-2 text-right text-gray-900 ${summaryKey.includes('Profit') ? 'text-lg' : ''}`}>{formatCurrency(calculatedTotals.annual[summaryKey])}</td>
                            </tr>
                        );
                    }
                 }

                if (item.viewType === 'data') {
                    return (
                        <tr key={item.id} className="bg-white border-b hover:bg-gray-50">
                            <td className="px-6 py-2 font-medium text-gray-900 sticky-col bg-white hover:bg-gray-50">{item.name}</td>
                            {months.map((month, index) => (
                                <td key={index} className="px-1 py-1 text-right">
                                    <div className="flex items-center justify-end">
                                        <input type="text" value={formatCurrency(item.values[index])}
                                            onChange={e => handleValueChange(item.id, index, e.target.value)}
                                            disabled={isActualMonth(month)}
                                            className={`w-full text-right bg-transparent border-0 rounded-md focus:ring-2 focus:ring-blue-300 ${isActualMonth(month) ? 'text-gray-500' : 'text-blue-600'}`}
                                        />
                                        {!isActualMonth(month) && (
                                            <button 
                                                onClick={() => handleFillRight(item.id, index)}
                                                title="以降の月に同額を入力"
                                                className="p-1 text-gray-400 hover:text-blue-600"
                                            >
                                                <Icon name="ChevronsRight" size={16} />
                                            </button>
                                        )}
                                    </div>
                                </td>
                            ))}
                            <td className="px-1 py-1 text-right">
                                <input type="text" value={formatCurrency(item.values[12])}
                                    onChange={e => handleValueChange(item.id, 12, e.target.value)}
                                    className="w-full text-right bg-transparent border-0 rounded-md focus:ring-2 focus:ring-blue-300 text-blue-600"
                                />
                            </td>
                            <td className="px-6 py-2 text-right font-semibold text-gray-800">{formatCurrency(item.values.reduce((s,v)=>s+v, 0))}</td>
                        </tr>
                    );
                }
                
                return <tr key={item.id}><td colSpan={15} className="py-2"></td></tr>;
            };

            return (
                <div className="w-full mx-auto p-4 sm:p-6 lg:p-8">
                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <div><h1 className="text-2xl md:text-3xl font-bold text-gray-800">決算予測</h1><p className="text-gray-600 mt-1">実績データに基づき、将来の計画値を入力して決算を予測します。</p></div>
                        <div className="flex gap-2">
                            <Button onClick={() => onComplete(accounts, calculatedTotals.annual)}><Icon name="Calculator" size={18} />税額計算へ進む</Button>
                        </div>
                    </div>
                    <div className="table-container border border-gray-200 rounded-lg shadow-sm">
                        <table className="w-full text-sm text-left text-gray-500">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-100 sticky-header">
                                <tr>
                                    <th scope="col" className="px-6 py-3 sticky-col w-48 bg-gray-100">勘定科目</th>
                                    {months.map(month => <th key={month} scope="col" className="px-6 py-3 text-right min-w-[120px]">{month}月 {isActualMonth(month) ? '(実績)' : '(計画)'}</th>)}
                                    <th scope="col" className="px-6 py-3 text-right min-w-[120px]">決算修正</th>
                                    <th scope="col" className="px-6 py-3 text-right font-bold min-w-[140px]">年間合計</th>
                                </tr>
                            </thead>
                            <tbody>
                                {accounts.map(renderRow)}
                            </tbody>
                        </table>
                    </div>
                     <div className="mt-8 flex justify-start">
                        <Button onClick={onReset} variant="danger"><Icon name="Trash2" size={18} />最初からやり直す</Button>
                    </div>
                </div>
            );
        };

        const ResultScreen = ({ simulationData, onBack, onReset }) => {
            const { annualTotals, capital, prefecture } = simulationData;
            const [taxSavingEntries, setTaxSavingEntries] = useState([{ id: 1, name: '', amount: 0 }]);
            const [broughtForwardLoss, setBroughtForwardLoss] = useState(0);

            const totalExpenseAmount = useMemo(() => {
                return taxSavingEntries.reduce((sum, entry) => sum + entry.amount, 0);
            }, [taxSavingEntries]);

            const preTaxProfit = annualTotals.preTaxProfit;
            
            const originalTaxResult = useMemo(() => calculateTaxes(preTaxProfit, capital, prefecture), [preTaxProfit, capital, prefecture]);
            
            const simulatedResult = useMemo(() => {
                const simulatedProfitAfterExpenses = preTaxProfit - totalExpenseAmount;
                const finalTaxableIncome = simulatedProfitAfterExpenses - broughtForwardLoss;
                const simulatedTaxResult = calculateTaxes(finalTaxableIncome, capital, prefecture);
                const taxSaved = originalTaxResult.totalTax - simulatedTaxResult.totalTax;
                const simulatedAfterTaxProfit = simulatedProfitAfterExpenses - simulatedTaxResult.totalTax;
                return { simulatedTaxResult, taxSaved, simulatedAfterTaxProfit };
            }, [totalExpenseAmount, broughtForwardLoss, preTaxProfit, capital, prefecture, originalTaxResult]);

            const afterTaxProfit = preTaxProfit - originalTaxResult.totalTax;

            const handleEntryChange = (id, field, value) => {
                setTaxSavingEntries(entries =>
                    entries.map(entry => {
                        if (entry.id === id) {
                            const newAmount = field === 'amount' ? parseInt(value.replace(/,/g, ''), 10) || 0 : entry.amount;
                            const newName = field === 'name' ? value : entry.name;
                            return { ...entry, name: newName, amount: newAmount };
                        }
                        return entry;
                    })
                );
            };

            const addEntry = () => {
                setTaxSavingEntries(entries => [...entries, { id: Date.now(), name: '', amount: 0 }]);
            };

            const removeEntry = (id) => {
                setTaxSavingEntries(entries => entries.filter(entry => entry.id !== id));
            };

            const ResultCard = ({ title, value, isLarge = false, children }) => (
                <div className={`bg-white p-6 rounded-lg shadow-md flex flex-col justify-between ${isLarge ? 'col-span-1 md:col-span-2' : ''}`}>
                    <div><h3 className="text-sm font-semibold text-gray-500">{title}</h3><p className={`font-bold text-gray-800 ${isLarge ? 'text-4xl' : 'text-3xl'}`}>{formatCurrency(value)} <span className="text-xl font-medium">円</span></p></div>
                    {children}
                </div>
            );
            return (
                <div className="max-w-5xl mx-auto p-8">
                    <h1 className="text-3xl font-bold text-gray-800 mb-2">決算・税額予測結果</h1>
                    <p className="text-gray-600 mb-8">入力された計画に基づく、年度末の予測サマリーです。</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <ResultCard title="売上高" value={annualTotals.revenue} />
                        <ResultCard title="営業利益" value={annualTotals.operatingProfit} />
                        <ResultCard title="経常利益" value={annualTotals.ordinaryProfit} />
                        <ResultCard title="税引前当期純利益" value={preTaxProfit} />
                        <Card className="col-span-1 lg:col-span-2">
                             <h3 className="font-semibold text-gray-700 mb-4">税額の内訳</h3>
                             <div className="space-y-3">
                                <div className="flex justify-between items-center"><span className="text-gray-600">法人税</span><span className="font-semibold text-gray-800">{formatCurrency(originalTaxResult.corporateTax)} 円</span></div>
                                <div className="flex justify-between items-center"><span className="text-gray-600">地方法人税</span><span className="font-semibold text-gray-800">{formatCurrency(originalTaxResult.localCorporateTax)} 円</span></div>
                                <div className="flex justify-between items-center"><span className="text-gray-600">法人住民税</span><span className="font-semibold text-gray-800">{formatCurrency(originalTaxResult.inhabitantsTax)} 円</span></div>
                                <div className="text-xs text-gray-500 pl-4">(均等割: {formatCurrency(originalTaxResult.details.inhabitants.base)} 円, 法人税割: {formatCurrency(originalTaxResult.details.inhabitants.ratePortion)} 円)</div>
                                <div className="flex justify-between items-center"><span className="text-gray-600">法人事業税</span><span className="font-semibold text-gray-800">{formatCurrency(originalTaxResult.enterpriseTax)} 円</span></div>
                                <div className="border-t mt-2 pt-2 flex justify-between items-center font-bold">
                                    <span className="text-gray-800">概算法人税等 合計額</span>
                                    <span className="text-lg text-red-600">{formatCurrency(originalTaxResult.totalTax)} 円</span>
                                </div>
                             </div>
                        </Card>
                        <ResultCard title="予測当期純利益 (税引後)" value={afterTaxProfit} isLarge={true}>
                           <div className="mt-4 pt-4 border-t border-gray-200"><p className="text-sm text-gray-500">実効税率: {preTaxProfit > 0 ? ((originalTaxResult.totalTax / preTaxProfit) * 100).toFixed(2) : '0.00'} %</p></div>
                        </ResultCard>
                        
                        <Card className="col-span-1 md:col-span-2 lg:col-span-4">
                            <h3 className="font-semibold text-gray-700 mb-2">節税対策シミュレーション</h3>
                            <div className="space-y-4">
                                <p className="text-sm text-gray-600 font-semibold">追加の経費（損金）</p>
                                <p className="text-xs text-gray-500 -mt-3">未払消費税、事業税の損金算入額などもこちらへ入力してください。</p>
                                {taxSavingEntries.map((entry, index) => (
                                    <div key={entry.id} className="grid grid-cols-12 gap-2 items-center">
                                        <div className="col-span-5">
                                            {index === 0 && <label className="block text-xs font-medium text-gray-700 mb-1">項目名</label>}
                                            <input 
                                                type="text"
                                                placeholder="（例）広告宣伝費"
                                                value={entry.name}
                                                onChange={(e) => handleEntryChange(entry.id, 'name', e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm"
                                            />
                                        </div>
                                        <div className="col-span-5">
                                            {index === 0 && <label className="block text-xs font-medium text-gray-700 mb-1">金額</label>}
                                            <input 
                                                type="text"
                                                value={formatCurrency(entry.amount)}
                                                onChange={(e) => handleEntryChange(entry.id, 'amount', e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm text-right"
                                            />
                                        </div>
                                        <div className="col-span-2 flex items-end h-full">
                                            {taxSavingEntries.length > 1 && (
                                                <Button onClick={() => removeEntry(entry.id)} variant="danger" className="p-2 h-10 w-10">
                                                    <Icon name="Trash2" size={16} />
                                                </Button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                <Button onClick={addEntry} variant="secondary" className="w-full">
                                    <Icon name="Plus" size={16} />
                                    経費項目を追加
                                </Button>

                                <div className="pt-4 border-t">
                                     <p className="text-sm text-gray-600 font-semibold">繰越欠損金の利用額</p>
                                     <input 
                                        type="text"
                                        value={formatCurrency(broughtForwardLoss)}
                                        onChange={(e) => setBroughtForwardLoss(parseInt(e.target.value.replace(/,/g, ''), 10) || 0)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm text-right"
                                    />
                                </div>
                            </div>
                            <div className="mt-6 grid md:grid-cols-3 gap-6 items-end">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <p className="text-sm text-blue-800">対策後の税額合計</p>
                                    <p className="text-2xl font-bold text-blue-900">{formatCurrency(simulatedResult.simulatedTaxResult.totalTax)} 円</p>
                                </div>
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <p className="text-sm text-green-800">削減される税額</p>
                                    <p className="text-2xl font-bold text-green-900">
                                        <Icon name="TrendingDown" className="inline-block mr-2 text-green-600" />
                                        {formatCurrency(simulatedResult.taxSaved)} 円
                                    </p>
                                </div>
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <p className="text-sm text-purple-800">対策後の当期純利益</p>
                                    <p className="text-2xl font-bold text-purple-900">{formatCurrency(simulatedResult.simulatedAfterTaxProfit)} 円</p>
                                </div>
                            </div>
                        </Card>
                    </div>
                    <div className="mt-8 flex flex-wrap gap-4">
                        <Button onClick={onBack}><Icon name="ArrowLeft" size={18} />決算予測に戻る</Button>
                        <Button onClick={onReset} variant="danger"><Icon name="Trash2" size={18} />最初からやり直す</Button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [screen, setScreen] = useState('setup');
            const [appData, setAppData] = useState(null);
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem(APP_STORAGE_KEY);
                    if (savedData) { setAppData(JSON.parse(savedData)); setScreen('planning'); }
                } catch (error) { localStorage.removeItem(APP_STORAGE_KEY); }
            }, []);
            useEffect(() => {
                if (appData) { try { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(appData)); } catch (error) { console.error(error); } }
            }, [appData]);
            
            const handleSetupComplete = (setupInfo) => { 
                setAppData({ ...setupInfo }); 
                setScreen('planning'); 
            };
            const handlePlanningComplete = (updatedAccounts, annualTotals) => { 
                setAppData(prev => ({ ...prev, accounts: updatedAccounts, annualTotals })); 
                setScreen('result'); 
            };
            const handleReset = () => {
                // エラーを避けるため、window.confirmを削除
                localStorage.removeItem(APP_STORAGE_KEY);
                window.location.reload();
            };
            const renderScreen = () => {
                switch (screen) {
                    case 'planning': return <PlanningScreen initialData={appData} onComplete={handlePlanningComplete} onReset={handleReset} />;
                    case 'result': return <ResultScreen simulationData={appData} onBack={() => setScreen('planning')} onReset={handleReset} />;
                    default: return <SetupScreen onSetupComplete={handleSetupComplete} />;
                }
            };
            return (
                <div className="min-h-screen bg-gray-50">
                    <main>{renderScreen()}</main>
                    <footer className="text-center py-8 px-4"><p className="text-xs text-gray-500"><strong>免責事項:</strong> 本シミュレーションは概算です。最終的な税務申告は必ず専門家にご確認ください。</p></footer>
                </div>
            );
        };
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>